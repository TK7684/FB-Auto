<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D Plus Skin — Bot Command Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header__left">
                <div class="header__logo">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                </div>
                <div>
                    <h1 class="header__title">Bot Command Center</h1>
                    <p class="header__subtitle">D Plus Skin · Monitoring Dashboard</p>
                </div>
            </div>
            <div class="header__right">
                <div class="header__status" id="systemStatusBadge">
                    <span class="status-dot status-dot--offline"></span>
                    <span id="systemStatusText">Connecting...</span>
                </div>
                <button class="btn btn--ghost" onclick="refreshAll()" title="Refresh">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10" />
                        <polyline points="1 20 1 14 7 14" />
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Metrics Row -->
        <section class="metrics">
            <div class="metric-card">
                <div class="metric-card__icon metric-card__icon--blue">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                </div>
                <div>
                    <p class="metric-card__label">Processed</p>
                    <p class="metric-card__value" id="metricProcessed">0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-card__icon metric-card__icon--green">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 11 12 14 22 4" />
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
                    </svg>
                </div>
                <div>
                    <p class="metric-card__label">Replies Sent</p>
                    <p class="metric-card__value" id="metricReplies">0</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-card__icon metric-card__icon--amber">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                    </svg>
                </div>
                <div>
                    <p class="metric-card__label">API Usage</p>
                    <p class="metric-card__value" id="metricApiUsage">0%</p>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-card__icon metric-card__icon--rose">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                    </svg>
                </div>
                <div>
                    <p class="metric-card__label">Uptime</p>
                    <p class="metric-card__value" id="metricUptime">--</p>
                </div>
            </div>
        </section>

        <!-- Two-Column Layout -->
        <div class="grid-2col">
            <!-- Left: Bots Table -->
            <section class="card">
                <div class="card__header">
                    <h2 class="card__title">Bot Fleet</h2>
                </div>
                <div class="card__body">
                    <table class="table" id="botsTable">
                        <thead>
                            <tr>
                                <th>Bot</th>
                                <th>Status</th>
                                <th>Last Active</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="botsTableBody">
                            <tr>
                                <td colspan="4" class="table__empty">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Right: Recent Activity -->
            <section class="card">
                <div class="card__header">
                    <h2 class="card__title">Recent Activity</h2>
                    <span class="badge badge--dim" id="activityCount">0 items</span>
                </div>
                <div class="card__body card__body--scroll" id="activityFeed">
                    <div class="activity-empty">No recent activity</div>
                </div>
            </section>
        </div>

        <!-- Logs Section -->
        <section class="card card--full">
            <div class="card__header">
                <h2 class="card__title">Live Logs</h2>
                <div class="card__actions">
                    <button class="btn btn--sm btn--ghost" onclick="clearLogs()">Clear</button>
                    <label class="toggle" title="Auto-scroll">
                        <input type="checkbox" id="autoScrollToggle" checked>
                        <span class="toggle__label">Auto-scroll</span>
                    </label>
                </div>
            </div>
            <div class="card__body">
                <pre class="log-viewer" id="logViewer">Waiting for logs...</pre>
            </div>
        </section>
    </div>

    <script>
        const API_BASE = '/api/dashboard';
        let refreshTimer = null;
        let startTime = Date.now();

        // --- Data Fetching ---
        async function fetchStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                if (!res.ok) return;
                const data = await res.json();
                renderStats(data);
                renderBots(data.bots || []);
            } catch (e) {
                console.error('Stats fetch failed:', e);
            }
        }

        async function fetchActivity() {
            try {
                const res = await fetch(`${API_BASE}/activity?limit=20`);
                if (!res.ok) return;
                const data = await res.json();
                renderActivity(data.activities || []);
            } catch (e) {
                console.error('Activity fetch failed:', e);
            }
        }

        async function fetchLogs() {
            try {
                const res = await fetch(`${API_BASE}/logs?lines=80`);
                if (!res.ok) return;
                const data = await res.json();
                renderLogs(data.logs || []);
            } catch (e) {
                console.error('Logs fetch failed:', e);
            }
        }

        // --- Renderers ---
        function renderStats(data) {
            document.getElementById('metricProcessed').textContent = (data.processed_count || 0).toLocaleString();
            document.getElementById('metricReplies').textContent = (data.reply_count || 0).toLocaleString();
            document.getElementById('metricApiUsage').textContent = `${data.api_usage || 0}%`;

            // Update system status badge
            const badge = document.getElementById('systemStatusBadge');
            const dot = badge.querySelector('.status-dot');
            const text = document.getElementById('systemStatusText');
            const isActive = data.system_status === 'active';
            dot.className = `status-dot ${isActive ? 'status-dot--active' : 'status-dot--offline'}`;
            text.textContent = isActive ? 'All Systems Online' : 'Offline';

            // Uptime
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const h = Math.floor(elapsed / 3600);
            const m = Math.floor((elapsed % 3600) / 60);
            document.getElementById('metricUptime').textContent = h > 0 ? `${h}h ${m}m` : `${m}m`;
        }

        function renderBots(bots) {
            const tbody = document.getElementById('botsTableBody');
            if (!bots.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="table__empty">No bots registered</td></tr>';
                return;
            }
            tbody.innerHTML = bots.map(bot => {
                const statusClass = bot.status === 'active' ? 'status--active' : (bot.status === 'paused' ? 'status--paused' : 'status--offline');
                const statusLabel = bot.status === 'active' ? 'Running' : (bot.status === 'paused' ? 'Paused' : 'Offline');
                const lastActive = bot.last_active || bot.last_run || '--';
                const action = bot.last_action || '--';
                return `<tr>
                <td><span class="bot-name">${escapeHtml(bot.bot_name || bot.bot_type || 'Unknown')}</span></td>
                <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
                <td class="text-dim">${lastActive}</td>
                <td class="text-dim">${escapeHtml(action)}</td>
            </tr>`;
            }).join('');
        }

        function renderActivity(activities) {
            const feed = document.getElementById('activityFeed');
            const countEl = document.getElementById('activityCount');
            countEl.textContent = `${activities.length} items`;

            if (!activities.length) {
                feed.innerHTML = '<div class="activity-empty">No recent activity</div>';
                return;
            }

            feed.innerHTML = activities.map(a => {
                const icon = a.status === 'success'
                    ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>'
                    : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--rose)" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>';

                return `<div class="activity-item">
                <div class="activity-item__icon">${icon}</div>
                <div class="activity-item__body">
                    <div class="activity-item__header">
                        <span class="activity-item__bot">${escapeHtml(a.bot)}</span>
                        <span class="activity-item__time">${a.timestamp}</span>
                    </div>
                    <p class="activity-item__msg">${escapeHtml(a.user || '')}${a.message ? ': ' + escapeHtml(a.message) : ''}</p>
                    ${a.reply ? `<p class="activity-item__reply">${escapeHtml(a.reply)}</p>` : ''}
                </div>
            </div>`;
            }).join('');
        }

        function renderLogs(lines) {
            const viewer = document.getElementById('logViewer');
            if (!lines.length) {
                viewer.textContent = 'No logs available';
                return;
            }
            viewer.innerHTML = lines.map(line => {
                let cls = 'log-line';
                if (line.includes('ERROR') || line.includes('CRITICAL')) cls += ' log-line--error';
                else if (line.includes('WARNING')) cls += ' log-line--warn';
                else if (line.includes('✓') || line.includes('✅') || line.includes('SUCCESS')) cls += ' log-line--success';
                return `<span class="${cls}">${escapeHtml(line)}</span>`;
            }).join('\n');

            if (document.getElementById('autoScrollToggle').checked) {
                viewer.scrollTop = viewer.scrollHeight;
            }
        }

        // --- Utilities ---
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function clearLogs() {
            document.getElementById('logViewer').textContent = 'Logs cleared.';
        }

        async function refreshAll() {
            await Promise.all([fetchStats(), fetchActivity(), fetchLogs()]);
        }

        // --- Init ---
        (async function init() {
            await refreshAll();
            refreshTimer = setInterval(refreshAll, 8000);
        })();
    </script>
</body>

</html>